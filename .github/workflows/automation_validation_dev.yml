name: Mezon FE - E2E Validation

on:
  workflow_dispatch:
  pull_request:
    branches: [develop]
    types: [opened, synchronize, reopened]

jobs:
  automation_validation_dev:
    runs-on: ubuntu-latest
    container:
      image: mcr.microsoft.com/playwright:v1.55.0-noble
    steps:
      - name: Checkout mezon-e2e repository
        uses: actions/checkout@v4
        with:
          repository: mezonai/mezon-e2e
          path: mezon-e2e

      - name: Checkout current repository
        uses: actions/checkout@v4
        with:
          path: mezon

      - name: Install system dependencies
        run: |
          apt-get update
          apt-get install -y \
            build-essential \
            make \
            g++ \
            wget \
            curl \
            software-properties-common \
            libx11-dev \
            libxss-dev \
            libxext-dev \
            libnss3-dev \
            libatk-bridge2.0-dev \
            libdrm2 \
            libxcomposite1 \
            libxdamage1 \
            libxrandr2 \
            libgbm1 \
            libxkbcommon0 \
            libasound2t64

      - name: Install Python 3.9
        run: |
          add-apt-repository ppa:deadsnakes/ppa -y
          apt-get update
          apt-get install -y python3.9 python3.9-dev python3.9-distutils
          # Create symlinks for easier access
          ln -sf /usr/bin/python3.9 /usr/local/bin/python3.9
          echo "Python 3.9 installed at: $(which python3.9)"
          python3.9 --version
      - name: Install mezon dependencies
        working-directory: ./mezon
        run: |
          echo "Installing mezon dependencies..."
          # Set Python 3.9 for node-gyp (similar to your local setup)
          export NODE_GYP_FORCE_PYTHON="/usr/bin/python3.9"
          export python="/usr/bin/python3.9"
          echo "Using Python: $python"
          echo "NODE_GYP_FORCE_PYTHON: $NODE_GYP_FORCE_PYTHON"
          # Verify Python version
          $python --version
          # Install dependencies
          yarn install
      - name: Start mezon dev server
        working-directory: ./mezon
        run: |
          echo "ğŸš€ Starting mezon dev server on port 4200..."
          echo "ğŸ“‹ Current directory: $(pwd)"
          echo "ğŸ“ Directory contents:"
          ls -la
          echo "ğŸ” Checking if nx command exists:"
          which nx || npx nx --version
          echo "ğŸ“¦ Node and npm versions:"
          node --version
          npm --version
          yarn --version
          echo "ğŸŒ Checking if port 4200 is available:"
          netstat -tuln | grep ":4200" || echo "Port 4200 is available"
          echo "ğŸƒ Starting server..."
          nohup npx nx run chat:serve --host=127.0.0.1 --port=4200 > mezon-dev.log 2>&1 &
          SERVER_PID=$!
          echo $SERVER_PID > mezon-dev.pid
          echo "ğŸ“‹ Server PID: $SERVER_PID"

          echo "â±ï¸ Waiting 10 seconds for initial startup..."
          sleep 10

          echo "ğŸ“œ Initial server log output:"
          head -50 mezon-dev.log || echo "No log file yet"

          echo "ğŸ” Checking if process is still running:"
          if ps -p $SERVER_PID > /dev/null; then
            echo "âœ… Server process is running (PID: $SERVER_PID)"
          else
            echo "âŒ Server process died! Full log:"
            cat mezon-dev.log || echo "No log file found"
            exit 1
          fi

      - name: Wait for mezon server to be ready
        run: |
          echo "â³ Waiting for mezon server to be ready on port 4200..."

          # Check if PID file exists
          if [ ! -f ./mezon/mezon-dev.pid ]; then
            echo "âŒ PID file not found!"
            exit 1
          fi

          SERVER_PID=$(cat ./mezon/mezon-dev.pid)
          echo "ğŸ“‹ Server PID from file: $SERVER_PID"

          # Check if process is running
          if ! ps -p $SERVER_PID > /dev/null; then
            echo "âŒ Server process is not running! Checking logs..."
            echo "ğŸ“œ Full server log:"
            cat ./mezon/mezon-dev.log || echo "No log file found"
            exit 1
          fi
      - name: Install mezon-e2e dependencies
        working-directory: ./mezon-e2e
        run: yarn

      - name: Install Playwright browsers
        working-directory: ./mezon-e2e
        run: npx playwright install chromium

      - name: Create environment file
        working-directory: ./mezon-e2e
        run: |
          cat > .env << EOF
          BASE_URL=http://localhost:4200/
          SKIP_LOGIN=true
          WORKERS=6
          CI=true
          EOF
      - name: Run automation tests
        id: run-tests
        working-directory: ./mezon-e2e
        run: |
          echo "ğŸ§ª Starting automation tests..."
          echo "ğŸ“Š Environment file content:"
          cat .env
          echo ""
          echo "ğŸš€ Running tests with yarn test..."

          # Run tests and capture exit code
          set +e  # Don't exit on error
          yarn test
          TEST_EXIT_CODE=$?
          set -e  # Re-enable exit on error

          echo "ğŸ“Š Test exit code: $TEST_EXIT_CODE"

          if [ $TEST_EXIT_CODE -eq 0 ]; then
            echo "âœ… All tests passed"
            echo "test-result=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ Some tests failed (exit code: $TEST_EXIT_CODE)"
            echo "test-result=failed" >> $GITHUB_OUTPUT
          fi
          echo "ğŸ”„ Continuing pipeline for cleanup and reporting..."
        continue-on-error: true

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: playwright-report
          path: mezon-e2e/playwright-report/
          retention-days: 7

      - name: Check test results and fail pipeline if needed
        if: always()
        run: |
          if [ "${{ steps.run-tests.outputs.test-result }}" == "failed" ]; then
            echo "âŒ Pipeline failed due to test failures"
            echo "ğŸ“Š Test results have been uploaded for analysis"
            exit 1
          else
            echo "âœ… Pipeline completed successfully"
          fi
